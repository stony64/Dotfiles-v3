#!/usr/bin/env bash
# ------------------------------------------------------------------------------
# FILE:          .bashprompt
# VERSION:       1.5.2 (Fix: Masking & No-Unset)
# ------------------------------------------------------------------------------

# Maskierte Farben
P_BLUE='\[\e[34m\]'
P_GREEN='\[\e[32m\]'
P_CYAN='\[\e[36m\]'
P_YELLOW='\[\e[33m\]'
P_RED='\[\e[31m\]'
P_MAGENTA='\[\e[35m\]'
P_RESET='\[\e[0m\]'

df_prompt_git() {
    git rev-parse --is-inside-work-tree >/dev/null 2>&1 || return 0
    local branch dirty="" remote="" ahead=0 behind=0 indicators=""

    branch=$(git symbolic-ref --short HEAD 2>/dev/null || git rev-parse --short HEAD 2>/dev/null)
    [[ -z "$branch" ]] && return 0

    # Schnellprüfung auf Änderungen
    if ! git diff --quiet 2>/dev/null; then dirty="${P_YELLOW}*"; fi

    # Upstream Check (Safe Expansion)
    local upstream
    upstream=$(git rev-parse --abbrev-ref --symbolic-full-name '@{u}' 2>/dev/null || echo "")
    if [[ -n "$upstream" ]]; then
        remote=" ${P_CYAN}${upstream%%/*}"
        ahead=$(git rev-list --left-right --count HEAD..."$upstream" 2>/dev/null | awk '{print $1}' || echo 0)
        behind=$(git rev-list --left-right --count HEAD..."$upstream" 2>/dev/null | awk '{print $2}' || echo 0)
        [[ ${ahead:-0} -gt 0 ]] && indicators+="${P_MAGENTA}+${ahead}"
        [[ ${behind:-0} -gt 0 ]] && indicators+="${P_MAGENTA}-${behind}"
    fi

    printf ' %s(%s%s%s%s)%s' "${P_RESET}" "${P_YELLOW}${branch}" "${dirty}" "${remote}" "${indicators}" "${P_RESET}"
}

# Exit-Code Indikator
set_prompt_exit_code() {
    local EXIT=$?
    if [[ $EXIT -ne 0 ]]; then
        EXIT_IND="${P_RED}✘ ${P_RESET}"
    else
        EXIT_IND=""
    fi
}

# Verhindert doppelte Einträge im PROMPT_COMMAND
[[ "$PROMPT_COMMAND" != *set_prompt_exit_code* ]] && PROMPT_COMMAND="set_prompt_exit_code; ${PROMPT_COMMAND:-}"

# PS1 Definition (Multi-Line)
# Die Farbcodes für @ und : wurden explizit maskiert
PS1="${P_CYAN}[${P_BLUE}\t${P_CYAN}] ${P_RED}\u${P_RESET}@${P_GREEN}\h${P_RESET}:${P_BLUE}\w\$(df_prompt_git)
\${EXIT_IND}\$ ${P_RESET}"

export PS1
