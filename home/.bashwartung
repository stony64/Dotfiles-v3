#!/usr/bin/env bash
# ------------------------------------------------------------------------------
# FILE:         .bashwartung
# VERSION:      1.0.1
# DESCRIPTION:  System-Wartung mit SC2015-bereinigten Host-Hooks.
# ------------------------------------------------------------------------------

# --- 0. INITIALISIERUNG -------------------------------------------------------
if ! command -v df_log_error >/dev/null 2>&1; then
    df_log_error()   { printf '\033[31m[ERR]\033[0m %s\n' "$*"; }
    df_log_success() { printf '\033[32m[OK]\033[0m %s\n' "$*"; }
    df_log_info()    { printf '\033[34m-->\033[0m %s\n' "$*"; }
fi

# --- 1. INTERNE HILFSFUNKTIONEN -----------------------------------------------

_df_wartung_apt_common() {
    export DEBIAN_FRONTEND=noninteractive
    df_log_info "APT Update + Upgrade..."

    if ! apt update; then
        df_log_error "apt update fehlgeschlagen"
        return 1
    fi

    if ! apt upgrade -y; then
        df_log_error "apt upgrade fehlgeschlagen"
        return 1
    fi

    apt autoremove -y || df_log_info "autoremove 端bersprungen"
    apt autoclean || df_log_info "autoclean 端bersprungen"

    return 0
}

# --- 2. HAUPTFUNKTION ---------------------------------------------------------

df_wartung_run() {
    if [[ "$(uname -s)" != *"Linux"* ]]; then
        df_log_error "Funktion nur unter Linux verf端gbar."
        return 1
    fi

    printf '\033[1m########################################\033[0m\n'
    df_log_info "System-Wartung f端r Host: $(hostname)"
    printf '\033[1m########################################\033[0m\n\n'

    if [[ "$EUID" -ne 0 ]]; then
        df_log_error "Root-Rechte erforderlich (sudo)."
        return 1
    fi

    if ! command -v apt >/dev/null 2>&1; then
        df_log_error "apt nicht gefunden."
        return 1
    fi

    # 1. APT Standard-Wartung
    _df_wartung_apt_common || return 1

    # 2. Host-spezifische Hooks (SC2015 Fix: Explizite if-Strukturen)
    case "$(hostname)" in
        proxmox*)
            df_log_info "Proxmox-Spezial: pveam update..."
            if command -v pveam >/dev/null 2>&1; then
                pveam update || df_log_error "pveam update fehlgeschlagen."
            else
                df_log_info "pveam ist auf diesem Host nicht aktiv."
            fi
            ;;
        raspifix*|pihole*)
            df_log_info "Pi-hole-Spezial: Updates..."
            if command -v pihole >/dev/null 2>&1; then
                pihole -up || df_log_error "Pi-hole Update fehlgeschlagen."
            else
                df_log_info "pihole Kommando nicht gefunden."
            fi

            if command -v pihole-updatelists >/dev/null 2>&1; then
                pihole-updatelists || df_log_error "pihole-updatelists fehlgeschlagen."
            fi
            ;;
    esac

    # 3. Locate-Datenbank
    if command -v updatedb >/dev/null 2>&1; then
        df_log_info "Aktualisiere locate-Datenbank..."
        updatedb || df_log_info "updatedb fehlgeschlagen."
    fi

    df_log_success "System-Wartung abgeschlossen."
    return 0
}
