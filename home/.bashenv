#!/usr/bin/env bash
# ------------------------------------------------------------------------------
# FILE:          .bashenv
# VERSION:       1.5.2
# DESCRIPTION:   Zentrale Umgebungsvariablen (Proxmox + Framework)
# AUTHOR:        Stony64
# ------------------------------------------------------------------------------

# ShellCheck safe (.shellcheckrc)
# shellcheck source=/dev/null disable=SC2155,SC2034

# Strict Mode (performant)
set -o errexit -o nounset -o pipefail

# --- EDITOR & VIEWER ----------------------------------------------------------
# Priorität: code/codium > nvim > micro > nano > vi
for cmd in code codium nvim micro nano vi; do
    if command -v "$cmd" >/dev/null 2>&1; then
        EDITOR="$cmd"
        VISUAL="$cmd"
        GIT_EDITOR="$cmd"
        export EDITOR VISUAL GIT_EDITOR
        break
    fi
done

# --- HISTORY SUPERCHARGED -----------------------------------------------------
HISTTIMEFORMAT="%F %T "
HISTCONTROL="ignoreboth:erasedups"
HISTIGNORE="&:ls:ll:la:lat:lah:l.:[ ]*:cd:cd ..:..:pwd:exit:clear:mc:au:fg:bg:jobs:history:df:du:dutop:dctl:proxmox:pct:qm:zfs:zpool:pveproxy"
HISTSIZE=10000
HISTFILESIZE=100000
export HISTTIMEFORMAT HISTCONTROL HISTIGNORE HISTSIZE HISTFILESIZE

shopt -s histappend cmdhist cdspell checkwinsize globstar direxpand

# History anhängen (performant)
PROMPT_COMMAND="history -a; ${PROMPT_COMMAND:-}"
export PROMPT_COMMAND

# --- MAN/LESS FARBEN (Terminal-aware) -----------------------------------------
if [[ "$TERM" != "dumb" ]] && command -v tput >/dev/null 2>&1; then
    MANPAGER="less -s -M +Gg"
    export MANPAGER

    # LESS_TERMCAP_* (man farbig – ShellCheck False Positive)
    # shellcheck disable=SC2034
    LESS_TERMCAP_mb="$(tput bold; tput setaf 1)"
    LESS_TERMCAP_md="$(tput bold; tput setaf 3)"
    LESS_TERMCAP_me="$(tput sgr0)"
    LESS_TERMCAP_se="$(tput rmso; tput sgr0)"
    LESS_TERMCAP_so="$(tput bold; tput setab 4; tput setaf 3)"
    LESS_TERMCAP_ue="$(tput rmul; tput sgr0)"
    LESS_TERMCAP_us="$(tput smul; tput setaf 2)"
    export LESS_TERMCAP_mb LESS_TERMCAP_md LESS_TERMCAP_me LESS_TERMCAP_se LESS_TERMCAP_so LESS_TERMCAP_ue LESS_TERMCAP_us

    # Modern less Flags
    LESS='-R -i -w -z-4 -M --shift=5'
    export LESS
fi

# --- FZF (falls installiert) --------------------------------------------------
# Ctrl+T Preview: bat mit Zeilennummern + Farben (sichere Quotes für Dateinamen)
# --- FZF (falls installiert) --------------------------------------------------
if command -v fzf >/dev/null 2>&1; then
    FZF_DEFAULT_OPTS='
        --height 50%
        --layout=reverse
        --border
        --margin=1
        --info=inline
    '

    FZF_CTRL_T_OPTS="--preview=bat --style=numbers --color=always --line-range=:500 {}"

    export FZF_DEFAULT_OPTS FZF_CTRL_T_OPTS
fi

# --- LOCALES (Tools C + UI Deutsch) -------------------------------------------
LC_ALL=C
export LC_ALL

if [[ "$(uname -s)" == "Linux" ]] && locale -a 2>/dev/null | grep -qE "(de_DE|de_DE.UTF-8)"; then
    LANG=de_DE.UTF-8
    LC_MESSAGES=de_DE.UTF-8
    LC_CTYPE=C.UTF-8
else
    LANG=en_US.UTF-8
    LC_MESSAGES=en_US.UTF-8
    LC_CTYPE=C.UTF-8
fi
export LANG LC_MESSAGES LC_CTYPE

# --- PROXMOX/ZFS EXTRAS -------------------------------------------------------
if [[ "$(uname -s)" == "Linux" ]]; then
    ZPOOL_FEATURES="async_destroy,bookmarks"
    export ZPOOL_FEATURES

    # Proxmox Proxy (falls pveproxy läuft)
    if command -v pveproxy >/dev/null 2>&1; then
        http_proxy="http://localhost:8006"
        export http_proxy
    fi
fi

# --- GPG/PINENTRY (modern) ----------------------------------------------------
GPG_TTY="$(tty)"
PINENTRY_USER_DATA="USE_CURSES=1"
export GPG_TTY PINENTRY_USER_DATA

# Framework (Dotfiles v3)
DF_PROJECT_VERSION="3.2.0"
export DF_PROJECT_VERSION DF_REPO_ROOT
