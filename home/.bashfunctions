#!/usr/bin/env bash
# ------------------------------------------------------------------------------
# FILE:          .bashfunctions
# VERSION:       1.7.0
# DESCRIPTION:   Power Bash Functions (Proxmox + Framework)
# AUTHOR:        Stony64
# ------------------------------------------------------------------------------

# ShellCheck safe (.shellcheckrc)
# shellcheck source=/dev/null disable=SC2034

# --- 0. BOOTSTRAP (Standalone Logging) ----------------------------------------
if ! command -v df_log_error >/dev/null 2>&1; then
    df_log_error()   { printf '\033[31m[ERR]\033[0m %s\n' "$*" >&2; }
    df_log_success() { printf '\033[32m[OK]\033[0m %s\n' "$*"; }
    df_log_info()    { printf '\033[34m-->\033[0m %s\n' "$*"; }
    df_log_warn()    { printf '\033[33m[!]\033[0m %s\n' "$*"; }
fi

# --- 1. ARCHIV (compress/extract) ---------------------------------------------
df_compress() {
    local name="$1"
    local source="$2"
    local target

    if [[ -z "$name" || -z "$source" ]]; then
        df_log_error "Usage: df_compress <name> <source>"
        return 1
    fi

    target="${name}.tar.xz"
    if tar -cvJf "$target" -- "$source"; then
        df_log_success "→ $target ($(du -h "$target" | cut -f1))"
    else
        df_log_error "Compression failed."
        return 1
    fi
}

extract() {
    local file="$1"
    local dir

    if [[ ! -f "$file" ]]; then
        df_log_error "No file: $file"
        return 1
    fi

    dir="${file%.*}"
    local success=0

    case "${file,,}" in
        *.tar.bz2|*.tbz2|*.tbz)   tar xjf "$file" || success=1 ;;
        *.tar.gz|*.tgz)           tar xzf "$file" || success=1 ;;
        *.tar.xz|*.txz)           tar xJf "$file" || success=1 ;;
        *.tar.zst)                unzstd "$file"  || success=1 ;;
        *.lz4)                    unlz4 "$file"   || success=1 ;;
        *.zip)                    unzip -q "$file" -d "${dir:-.}" || success=1 ;;
        *.7z)                     if command -v 7z >/dev/null 2>&1; then 7z x "$file" -o"${dir:-.}"; else df_log_error "Install 7z"; success=1; fi ;;
        *.rar)                    if command -v unrar >/dev/null 2>&1; then unrar x "$file"; else df_log_error "Install unrar"; success=1; fi ;;
        *.gz)                     gunzip "$file"  || success=1 ;;
        *.bz2)                    bunzip2 "$file" || success=1 ;;
        *.xz)                     unxz "$file"    || success=1 ;;
        *.zst)                    unzstd "$file"  || success=1 ;;
        *) df_log_error "Unknown format: $file"; return 1 ;;
    esac

    if [[ $success -eq 0 ]]; then
        df_log_success "Extracted: $file $([[ -d "$dir" ]] && echo "→ $dir" || echo "flat")"
        if [[ -d "$dir" ]]; then
            cd "$dir" || return 1
        fi
    else
        df_log_error "Extraction of $file failed."
        return 1
    fi
}

# --- 2. SUCHE (hg/ff/ft) -----------------------------------------------------
hg() {  # History grep
    [[ -z "$1" ]] && { df_log_error "Usage: hg <term>"; return 1; }
    history | grep -i --color=auto -- "$1" | tail -20
}

ff() {  # Find files
    [[ -z "$1" ]] && { df_log_error "Usage: ff <name>"; return 1; }
    find . -iname "*$1*" -not -path '*/\.*' -not -path '*/node_modules/*' 2>/dev/null | head -20
}

ft() {  # File text
    local term="$1"
    local mask="${2:-*}"

    [[ -z "$term" ]] && { df_log_error "Usage: ft <text> [mask]"; return 1; }
    grep -rniI --color=auto \
        --exclude-dir={.git,node_modules,build,dist} \
        --include="*$mask*" -- "$term" . 2>/dev/null | head -50
}

# --- 3. META (aliases/functions) ----------------------------------------------
show_aliases() {
    df_log_info "Aliasse ($(alias | wc -l)):"
    alias | sed 's/^alias //' | column -t -s'=' | less -R
}

show_functions() {
    df_log_info "Funktionen ($(declare -F | wc -l)):"
    declare -F | awk '{print $NF}' | grep -v '^_' | sort | column | less -R
}

# --- 4. NAVIGATION (mkd/lt/cdd) -----------------------------------------------
mkd() {
    mkdir -p -- "$@" && cd -- "${1:-.}" || return 1
}

lt() {
    local target="${1:-.}"
    # FIX SC2015: if-else statt && ||
    if command -v tree >/dev/null 2>&1; then
        tree -aC -I '.git|node_modules|.DS_Store|backup' --dirsfirst "$target" | less -R
    else
        find "$target" -maxdepth 3 -not -path '*/\.*' | sed 's|^\./||' | column
    fi
}

cdd() { cd "${DF_REPO_ROOT:-/opt/dotfiles}" || return 1; }
fsize() { du -sh ./* 2>/dev/null | sort -h; }

# --- 5. SYSTEM/PROXMOX (mem/ip/port) ------------------------------------------
df_mem_top() {
    df_log_info "Top 10 RAM:"
    ps auxf | sort -nr -k 4 | head -11 | sed '1i USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND'
}

df_myip() {
    local local_ipv4 pub_ip
    local_ipv4="$(hostname -I 2>/dev/null | awk '{print $1}' || ip route get 1.1.1.1 2>/dev/null | awk '{print $7}' | head -1)"
    [[ -n "$local_ipv4" ]] && df_log_info "Local IPv4: $local_ipv4"

    pub_ip="$(curl -s --connect-timeout 3 --max-time 5 https://api.ipify.org 2>/dev/null || \
             curl -s --connect-timeout 3 https://ifconfig.me 2>/dev/null || \
             curl -s --connect-timeout 3 https://icanhazip.com 2>/dev/null)"

    if [[ -n "$pub_ip" ]]; then
        df_log_success "Public IP: $pub_ip"
    else
        df_log_warn "Public IP offline"
    fi
}

port() {
    [[ -z "$1" ]] && { df_log_error "Usage: port <num>"; return 1; }
    ss -tulpn | grep ":$1"
}

# --- 6. CLEANUP (links/zfs/pve) -----------------------------------------------
df_clean_links() {
    local count=0
    # Nutze ein temporäres File oder Array, um Probleme mit Subshells zu vermeiden
    while read -r link; do
        if rm -v "$link"; then
            ((count++))
        fi
    done < <(find . -xtype l -print)

    if [[ $count -gt 0 ]]; then
        df_log_success "Gelöscht: $count tote Links"
    else
        df_log_info "Keine toten Links gefunden."
    fi
}

pve_status() {
    if command -v pvesh >/dev/null 2>&1; then
        pvesh get /nodes --output-format json-pretty-pretty | jq '.data[] | {node: .node, status: .status, cpu: .cpu, mem: .mem}'
    else
        df_log_warn "pvesh not found (No PVE Node?)"
    fi
}

zfs_status() {
    if command -v zpool >/dev/null 2>&1; then
        zpool status -v | head -30
    else
        df_log_warn "No ZFS found on this system."
    fi
}
